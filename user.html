<!DOCTYPE html>
<html>
<head>
  <title>User Page</title>
</head>
<body>
  <h1>Welcome!</h1>
  <p>This is just a normal page.</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "YOUR-API-KEY",
      authDomain: "YOUR-PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR-PROJECT.firebaseio.com",
      projectId: "YOUR-PROJECT",
      storageBucket: "YOUR-PROJECT.appspot.com",
      messagingSenderId: "SENDER-ID",
      appId: "APP-ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("id");

    async function logVisit() {
      try {
        // Get public IP from ipify
        const ipRes = await fetch("https://api.ipify.org?format=json");
        const ipData = await ipRes.json();

        await push(ref(db, "sessions/" + sessionId + "/visits"), {
          ip: ipData.ip,
          userAgent: navigator.userAgent,
          time: Date.now()
        });
      } catch (e) {
        console.error("Failed to log visit:", e);
      }
    }

    if (sessionId) logVisit();
  </script>
</body>
</html>
